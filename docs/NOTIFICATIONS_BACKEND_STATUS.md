# حالة موديول الإشعارات في الباكند

## ملخص سريع

| البند | الحالة |
|-------|--------|
| موديول الإشعارات (Settings + notificationService) | ✅ مضبوط |
| ربط واتساب (Wawp) مع الإعدادات والـ env | ✅ يعمل عند الاتصال |
| التريجرز المربوطة بأحداث الباكند | ٥ من ٧ (٢ غير مفعّلة بأي حدث) |

---

## ١. التريجرز الشغالة في الباكند

هذه التريجرز **مستدعاة فعلياً** عند حدوث الحدث، وإذا كان التريجر مفعّلاً وقناة واتساب مفعّلة وواتساب متصل، يُرسل الإشعار.

| التريجر | الملف | الحدث |
|---------|-------|--------|
| **حجز جديد** `new_appointment` | `appointmentController.ts` (create) | عند إنشاء موعد جديد |
| **تعديل الحجز** `edit_appointment` | `appointmentController.ts` (update) | عند تحديث موعد (والحالة ليست ملغى) |
| **إلغاء الحجز** `cancel_appointment` | `appointmentController.ts` (update) | عند تحديث موعد والحالة = `cancelled` |
| **فاتورة جديدة** `new_invoice` | `invoiceController.ts` (create) | عند إنشاء فاتورة |
| **وصفة جديدة** `new_prescription` | `prescriptionController.ts` (create) | عند إنشاء وصفة |

ملاحظة: إلغاء الحجز يعتمد على أن **كود الحالة** في النظام يكون بالضبط `cancelled` (كما في الـ default statuses). إذا غيّرت الكود في إعدادات الحالات لشيء آخر (مثلاً `canceled`) فلن يُطلق تريجر الإلغاء.

---

## ٢. التريجرز غير مربوطة بأي حدث في الباكند

هذه التريجرز **موجودة في الواجهة وفي `notificationService`** (القالب والتاجات والـ TriggerId)، لكن **لا يوجد في الباكند أي كود يستدعي `sendNotification`** لها (لا عند حدث ولا عند كرون).

| التريجر | الوصف | المطلوب لتفعيلها |
|---------|-------|-------------------|
| **تذكير بالموعد** `appointment_reminder` | تذكير قبل الموعد (مثلاً يوم أو ساعات) | جدولة (Cron/Job) تشغّل دورياً، تبحث عن مواعيد قادمة وترسل إشعار للمرضى |
| **فاتورة متأخرة** `overdue_invoice` | إشعار بفواتير لم تُسدّد بعد مدة | جدولة (Cron/Job) تشغّل دورياً، تبحث عن فواتير بحالة `overdue` وترسل إشعار للمرضى |

حالياً لا يوجد في المشروع أي `cron` أو `node-schedule` أو مشابه؛ إضافة هذه الوظائف تتطلب إضافة مكتبة جدولة وتشغيل الدورة من الباكند.

---

## ٣. ربط واتساب (Wawp)

- **مصدر الإعداد**: يُقرأ من `Settings.notifications.wawp` (instanceId + accessToken) أو من متغيرات البيئة `WAWP_INSTANCE_ID` و `WAWP_ACCESS_TOKEN`.
- **السلوك**: عند استدعاء `sendNotification`:
  1. يتم تحميل إعدادات العيادة (`Settings.findOne({ clinicId })`).
  2. إذا كان التريجر مفعّلاً وقناة واتساب مفعّلة، يُستخدم قالب واتساب (عربي/إنجليزي).
  3. يُستبدل القالب بالـ payload (مثل `{{patient_name}}`, `{{appointment_date}}`).
  4. إذا وُجدت إعدادات Wawp (من الإعدادات أو من الـ env)، تُرسل الرسالة عبر `sendWawpWhatsApp` إلى رقم المريض كـ `chatId`.
- **النتيجة**: الربط مع قناة واتساب **شغال** عندما:
  - واتساب **متصل** (Instance ID + Access Token صحيحان في الإعدادات أو في الـ env)،
  - والتريجر **مفعّل** وقناة **واتساب** مفعّلة في تبويب الإشعارات.

---

## ٣.١ إعدادات الواتساب والإشعارات على مستوى الفرع الرئيسي (Main/Sub)

- **الفرع الرئيسي (Main Clinic)** هو مصدر إعدادات الربط بالواتساب والتريجرز.
- **الفروع الفرعية (Sub Clinics)** ترث هذه الإعدادات ولا تُخزّن نسخة مستقلة (للقراءة تُعرض إعدادات الرئيسي؛ للإرسال تُستخدم إعدادات الرئيسي).

| السلوك | الوصف |
|--------|--------|
| **عرض الإعدادات** | عند فتح الإعدادات من فرع فرعي، يتم إرجاع إعدادات الإشعارات والواتساب الخاصة بالفرع الرئيسي (نفس الربط ونفس التريجرز). |
| **الحفظ من الفرع الرئيسي** | عند حفظ الربط أو التريجرز من الفرع الرئيسي، يتم تحديث إعدادات الرئيسي ثم **نشر** نفس الإعدادات على كل الفروع الفرعية (لكل فرع نسخة في سجل الإعدادات لتسريع القراءة). |
| **إرسال الإشعار** | عند إرسال إشعار من فرع فرعي (مثلاً حجز جديد في فرع)، الباكند يستخدم إعدادات **الفرع الرئيسي** (Wawp + قوالب) لإرسال الرسالة. |

الملفات المعنية في **clinc_backend**: `settingsController.ts` (getSettings يدمج إعدادات الرئيسي للفروع، updateSettings ينشر من الرئيسي إلى الفروع)، `notificationService.ts` (يحدد الفرع الفعلي للقراءة = الرئيسي إن كان الطلب من فرع فرعي).

---

## ٤. الملفات ذات الصلة

| الملف | الوظيفة |
|-------|----------|
| `src/models/Settings.ts` | `notifications.triggers`, `notifications.wawp` |
| `src/utils/notificationService.ts` | `sendNotification`, `sendWawpWhatsApp`, `fillTemplate`, `phoneToChatId` |
| `src/controllers/appointmentController.ts` | استدعاء إشعار حجز جديد / تعديل / إلغاء |
| `src/controllers/invoiceController.ts` | استدعاء إشعار فاتورة جديدة |
| `src/controllers/prescriptionController.ts` | استدعاء إشعار وصفة جديدة |
| `src/controllers/settingsController.ts` | تحديث الإعدادات (بما فيها notifications) |

---

## ٥. الخلاصة

- **موديول الإشعارات والتريجرز**: مضبوط في الباكند؛ التريجرز الخمسة (حجز جديد، تعديل حجز، إلغاء حجز، فاتورة جديدة، وصفة جديدة) مربوطة بأحداث وتعمل.
- **جميع أنواع الإشعارات**: الخمسة أعلاه تعمل؛ **تذكير بالموعد** و **فاتورة متأخرة** غير مربوطة بأي حدث أو جدولة في الباكند حتى الآن.
- **الربط مع واتساب**: شغال عندما يكون Wawp متصلاً (إعدادات أو env) والتريجر وقناة واتساب مفعّلين.

لتفعيل **تذكير بالموعد** و **فاتورة متأخرة** يلزم إضافة جدولة (مثل cron job) في الباكند واستدعاء `sendNotification` بالـ trigger المناسب والـ payload من المواعيد/الفواتير.
